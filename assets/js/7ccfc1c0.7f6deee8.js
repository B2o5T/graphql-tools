(self.webpackChunk_graphql_tools_website=self.webpackChunk_graphql_tools_website||[]).push([[3917],{5318:function(e,t,r){"use strict";r.d(t,{Zo:function(){return u},kt:function(){return d}});var n=r(7378);function a(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function i(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function o(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?i(Object(r),!0).forEach((function(t){a(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):i(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function l(e,t){if(null==e)return{};var r,n,a=function(e,t){if(null==e)return{};var r,n,a={},i=Object.keys(e);for(n=0;n<i.length;n++)r=i[n],t.indexOf(r)>=0||(a[r]=e[r]);return a}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)r=i[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(a[r]=e[r])}return a}var s=n.createContext({}),p=function(e){var t=n.useContext(s),r=t;return e&&(r="function"==typeof e?e(t):o(o({},t),e)),r},u=function(e){var t=p(e.components);return n.createElement(s.Provider,{value:t},e.children)},h={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},m=n.forwardRef((function(e,t){var r=e.components,a=e.mdxType,i=e.originalType,s=e.parentName,u=l(e,["components","mdxType","originalType","parentName"]),m=p(r),d=a,c=m["".concat(s,".").concat(d)]||m[d]||h[d]||i;return r?n.createElement(c,o(o({ref:t},u),{},{components:r})):n.createElement(c,o({ref:t},u))}));function d(e,t){var r=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var i=r.length,o=new Array(i);o[0]=m;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:a,o[1]=l;for(var p=2;p<i;p++)o[p]=r[p];return n.createElement.apply(null,o)}return n.createElement.apply(null,r)}m.displayName="MDXCreateElement"},833:function(e,t,r){"use strict";r.r(t),r.d(t,{frontMatter:function(){return o},metadata:function(){return l},toc:function(){return s},default:function(){return u}});var n=r(9603),a=r(120),i=(r(7378),r(5318)),o={id:"relay-operation-optimizer",title:"Optimizing operations using Relay Compiler",sidebar_label:"Relay Operation Optimizer"},l={unversionedId:"relay-operation-optimizer",id:"relay-operation-optimizer",isDocsHomePage:!1,title:"Optimizing operations using Relay Compiler",description:"@graphql-tools/relay-operation-optimizer is a package for bringing the benefits of Relay Compiler to GraphQL tools. This package is used in flattenGeneratedTypes feature of GraphQL Code Generator.",source:"@site/docs/relay-operation-optimizer.md",sourceDirName:".",slug:"/relay-operation-optimizer",permalink:"/docs/relay-operation-optimizer",editUrl:"https://github.com/ardatan/graphql-tools/edit/master/website/docs/relay-operation-optimizer.md",version:"current",sidebar_label:"Relay Operation Optimizer",frontMatter:{id:"relay-operation-optimizer",title:"Optimizing operations using Relay Compiler",sidebar_label:"Relay Operation Optimizer"},sidebar:"someSidebar",previous:{title:"Extracting GraphQL definitions from code files",permalink:"/docs/graphql-tag-pluck"},next:{title:"Migration to v7",permalink:"/docs/migration-from-tools"}},s=[{value:"Current List of Features",id:"current-list-of-features",children:[]},{value:"Install Instructions",id:"install-instructions",children:[]},{value:"Usage",id:"usage",children:[]}],p={toc:s};function u(e){var t=e.components,r=(0,a.Z)(e,["components"]);return(0,i.kt)("wrapper",(0,n.Z)({},p,r,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"@graphql-tools/relay-operation-optimizer")," is a package for bringing the benefits of Relay Compiler to GraphQL tools. This package is used in ",(0,i.kt)("a",{parentName:"p",href:"https://graphql-code-generator.com/docs/plugins/relay-operation-optimizer"},(0,i.kt)("inlineCode",{parentName:"a"},"flattenGeneratedTypes")," feature of GraphQL Code Generator"),"."),(0,i.kt)("p",null,"This package has been created by ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/n1ru4l"},"Laurin Quast (n1ru4l)")," as ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/n1ru4l/graphql-codegen-relay-plugins"},"a GraphQL Code Generator plugin"),"."),(0,i.kt)("h3",{id:"current-list-of-features"},"Current List of Features"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://relay.dev/docs/en/compiler-architecture#transforms"},"Optimize Queries")," TL;DR: reduce query size",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"Inline Fragments"),(0,i.kt)("li",{parentName:"ul"},"Flatten Transform"),(0,i.kt)("li",{parentName:"ul"},"Skip Redundant Node Transform"))),(0,i.kt)("li",{parentName:"ul"},"FragmentArguments",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://relay.dev/docs/en/graphql-in-relay#argumentdefinitions"},(0,i.kt)("inlineCode",{parentName:"a"},"@argumentsDefinition"))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://relay.dev/docs/en/graphql-in-relay#arguments"},(0,i.kt)("inlineCode",{parentName:"a"},"@arguments")))))),(0,i.kt)("h2",{id:"install-instructions"},"Install Instructions"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"yarn add -D -E @graphql-tools/relay-operation-optimizer")),(0,i.kt)("h2",{id:"usage"},"Usage"),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},"Taken from the blog post ",(0,i.kt)("a",{parentName:"p",href:"https://the-guild.dev/blog/graphql-codegen-relay-compiler"},"Optimizing your Apollo Operations with GraphQL Code Generator and the Relay Compiler"),".")),(0,i.kt)("p",null,"Let\u2019s take a look at the following Fragment:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-graphql"},"fragment UserAvatar on User {\n  id\n  avatar(width: 10, height: 10) {\n    id\n    url\n  }\n}\n")),(0,i.kt)("p",null,"How would you reuse this fragment with different values for the ",(0,i.kt)("inlineCode",{parentName:"p"},"width")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"height")," arguments?"),(0,i.kt)("p",null,"Previously there have been two ways:"),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"1. Write a new fragment with different parameters")),(0,i.kt)("p",null,"Well, just creating a new document for our avatar won\u2019t really solve the reusability issue."),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"2. Use variables and rely on the query to have those defined")),(0,i.kt)("p",null,"Actually, you can already use variables inside fragments. We just need to ensure that the query that uses the fragment also has those variables in the variable definition."),(0,i.kt)("p",null,"Fragment Definition:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-graphql"},"fragment UserAvatar on User {\n  id\n  avatar(width: $width, height: $height) {\n    id\n    url\n  }\n}\n")),(0,i.kt)("p",null,"Query Definition:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-graphql"},"query ProfileQuery($width: Int!, $height: Int!) {\n  me {\n    ...UserAvatar\n  }\n}\n")),(0,i.kt)("p",null,"However, we now rely on having those parameters provided in each query that uses that fragment."),(0,i.kt)("p",null,"This does not really make the fragment reusable. Imagine having a profile query of a with a friend list. The profile picture should be bigger than the ones of the friends."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-graphql"},"query ProfileQuery($width: Int!, $height: Int!) {\n  me {\n    id\n    ...UserAvatar\n    friends(first: 10) {\n      id\n      ...UserAvatar\n    }\n  }\n}\n")),(0,i.kt)("p",null,"It is basically impossible to use a different width and height for the second usage of the fragment in that query."),(0,i.kt)("p",null,"Furthermore, when using different fragments you have to be really careful with your variable names, because of variable name clashes."),(0,i.kt)("p",null,"Given those limitations, it is pretty obvious that this \u201csolution\u201d does not scale well."),(0,i.kt)("p",null,"Relay simply uses custom GraphQL directives to address this issue."),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Defining Fragment Variables with ",(0,i.kt)("inlineCode",{parentName:"strong"},"@argumentDefinitions"))),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-graphql"},"fragment UserAvatar on User @argumentDefinitions(\n  width: { type: \u201cInt\u201d, defaultValue: 10 },\n  height: { type: \u201cInt\u201d, defaultValue: 10 }\n) {\n  id\n  avatar(width: $width, height: $height) {\n    id\n    url\n  }\n}\n")),(0,i.kt)("p",null,"Providing Fragment Variables with ",(0,i.kt)("inlineCode",{parentName:"p"},"@arguments")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-graphql"},"query ProfileQuery {\n  me {\n    id\n    ...UserAvatar @arguments(height: 20, width: 20)\n    friends(first: 10) {\n      id\n      ...UserAvatar # fallback to defaultValue here\n    }\n  }\n}\n")),(0,i.kt)("p",null,"Pretty powerful, right?"),(0,i.kt)("p",null,"Unfortunately, you cannot simply use those fragments with your existing GraphQL Server. ",(0,i.kt)("inlineCode",{parentName:"p"},"@argumentDefinitions")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"@arguments")," are some custom directives that need to be understood by the server in order to process them."),(0,i.kt)("p",null,"However, instead of implementing those directives on the serverside Relay went another route. The ",(0,i.kt)("inlineCode",{parentName:"p"},"relay-compiler")," removes those directives at build time. That means after our query has been processed it looks something like the following:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-graphql"},"query ProfileQuery {\n  me {\n    id\n    ... on User {\n      id\n      avatar(width: 20, height: 20) {\n        id\n        url\n      }\n    }\n    friends(first: 10) {\n      id\n      ... on User {\n        id\n        avatar(width: 10, height: 10) {\n          id\n          url\n        }\n      }\n    }\n  }\n}\n")),(0,i.kt)("p",null,"Pretty neat. This allows the query the be accepted by every GraphQL server (that, of course, provides the correct schema), without relying on those custom directives."),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"The ",(0,i.kt)("inlineCode",{parentName:"strong"},"relay-compiler")," is awesome!")),(0,i.kt)("p",null,"It comes with a lot more transforms. Some of those are specific to the ",(0,i.kt)("inlineCode",{parentName:"p"},"relay-runtime")," (which as the name says is executed in the browser of the user like react-apollo), but others are definitely also beneficial to non-relay users."),(0,i.kt)("p",null,"Besides the so-called ",(0,i.kt)("inlineCode",{parentName:"p"},"RelayApplyFragmentArgumentTransform")," there is a bunch of more useful stuff."),(0,i.kt)("p",null,"E.g. the ",(0,i.kt)("inlineCode",{parentName:"p"},"FlattenTransform")," can improve our query even more:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-graphql"},"query ProfileQuery {\n  me {\n    id\n    avatar(width: 20, height: 20) {\n      id\n      url\n    }\n    friends(first: 10) {\n      id\n      avatar(width: 10, height: 10) {\n        id\n        url\n      }\n    }\n  }\n}\n")),(0,i.kt)("p",null,(0,i.kt)("a",{parentName:"p",href:"https://github.com/n1ru4l"},"Laurin Quast")," also built a ",(0,i.kt)("a",{parentName:"p",href:"https://relay-compiler-repl.netlify.com/"},"relay-compiler REPL")," (use it for convincing your team \ud83d\ude09)."),(0,i.kt)("p",null,"Of course, you can also read more about those in the ",(0,i.kt)("a",{parentName:"p",href:"https://relay.dev/docs/en/compiler-architecture#transforms"},"Official Relay Documentation"),"."),(0,i.kt)("p",null,"Especially on big queries, that utilize many fragments, those transforms can drastically reduce the query payload size, resulting in faster response times. For developers that cannot use persisted queries (because they do not own the server), this is a must-have!"))}u.isMDXComponent=!0}}]);